{% extends 'base.html' %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4">My Tasks</h1>
    <a class="btn btn-outline-secondary" href="{{ url_for('home') }}">Home</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Last 7 Days Activity</div>
      </div>
      <canvas id="activityChart" height="100"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    (function(){
      function loadActivity(){
        fetch("{{ url_for('my_activity_json') }}", { credentials: "same-origin" })
          .then(r => r.json())
          .then(d => {
            if(!d || !d.labels){ return; }
            var ctx = document.getElementById('activityChart');
            if(!ctx){ return; }
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: d.labels,
                datasets: [
                  {
                    label: 'Started',
                    data: d.start,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13,110,253,.15)',
                    tension: .3,
                    fill: true
                  },
                  {
                    label: 'Completed',
                    data: d.complete,
                    borderColor: '#20c997',
                    backgroundColor: 'rgba(32,201,151,.15)',
                    tension: .3,
                    fill: true
                  }
                ]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: true } },
                scales: {
                  y: { beginAtZero: true, ticks: { precision: 0 } }
                }
              }
            });
          }).catch(function(e){});
      }
      if(document.readyState === 'complete' || document.readyState === 'interactive'){
        loadActivity();
      } else {
        document.addEventListener('DOMContentLoaded', loadActivity);
      }
    })();
  </script>

  {% if tasks %}
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Due</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for t in tasks %}
        <tr>
          <td>{{ t.id }}</td>
          <td class="text-break">{{ t.title }}</td>
          <td>
            <span class="badge text-bg-{% if t.status=='done' %}success{% elif t.status=='in_progress' %}primary{% elif t.status=='blocked' %}danger{% else %}secondary{% endif %}">{{ t.status.replace('_',' ') }}</span>
          </td>
          <td>
            <span class="badge text-bg-{% if t.priority=='high' %}danger{% elif t.priority=='low' %}secondary{% else %}warning{% endif %}">{{ t.priority }}</span>
          </td>
          <td>{{ t.due_date or '-' }}</td>
          <td>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('my_task_detail', task_id=t.id) }}">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="alert alert-info">No tasks assigned yet.</div>
  {% endif %}
{% endblock %}
